#!/bin/bash
##################################################################################################
# Explanation:
# * This code calculates partial volume corrected SUVs (NOT RESCALED) of flipped PET files 
#   based on coreg param and gtmseg

export FREESURFER_HOME=/usr/local/freesurfer_6/freesurfer
FSFOLDER_DIR=/DATA/IMAGE_DAY/FS/3_fsresults_gtmseg
PET_INPUT_FOLDER=/DATA/IMAGE_DAY/PET/2_flipped_nii_pet_fromserver
PARAM_INPUT_FOLDER=/DATA/IMAGE_DAY/PET/3_mri-pet_coreg/param
GTMPVC_OUTPUT_FOLDER=/DATA/IMAGE_DAY/PET/4_gtmpvc

pettype="_apet" #<- "_apet" or "_fpet"
SUBJECTS=(10009989 10037162 10039803 10049406 10057135 10060232 10088913 10121757 10124059 10124129 10124578 10132384 10188394 10193149 10200186 10221176 10286623 10292457 10297111 10299193 10348158 10352708 10361430 10384109 10415623 10431593 10436839 10462256 10463538 10483549 10487611 10495751 10582554 10606607 10622630 10626719 10636350 )

MRI_DATES=(180124 191121 151211 160818 180118 200603 161111 181123 191129 180115 191030 200909 181128 191210 190115 171121 191211 200619 200914 200720 170202 170506 201017 181005 191211 191203 170331 201026 181025 180907 200828 200819 200304 200410 181127 180905 181129 )

PET_DATES=(190227 191211 170201 170722 180124 200601 161103 181119 180130 171129 191030 200909 181128 180129 170708 170603 180511 200619 200915 200811 170330 180509 201023 180331 191211 191203 170331 201012 170327 200703 200908 200819 200304 200410 170527 180907 170121 )
##################################################################################################

source $FREESURFER_HOME/SetUpFreeSurfer.sh
SUBJECTS_DIR=$FSFOLDER_DIR

for idx in ${!SUBJECTS[*]}

	do
	subj="r"${SUBJECTS[$idx]}"_"${MRI_DATES[$idx]}
	subj_pet=${SUBJECTS[$idx]}"_"${PET_DATES[$idx]}$pettype	

	mri_gtmpvc --i $PET_INPUT_FOLDER/"flip_"$subj_pet.nii \
		   --reg $PARAM_INPUT_FOLDER/$subj_pet"_coreg2M"${MRI_DATES[$idx]}.reg.lta   \
		   --seg $SUBJECTS_DIR/$subj/mri/gtmseg.mgz \
		   --psf 8 --default-seg-merge --auto-mask PSF .01 \
		   --o $GTMPVC_OUTPUT_FOLDER/gtmpvc_$subj_pet"_coreg2M"${MRI_DATES[$idx]}.output \
		   --no-rescale
done
